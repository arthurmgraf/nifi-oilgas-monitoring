# =============================================================================
# NiFi Oil & Gas Monitoring Platform - Docker Compose
# =============================================================================
# 16 services with profile-based deployment (dev, staging, prod).
#
# Usage:
#   docker compose --profile dev    up -d        # Development
#   docker compose --profile staging up -d       # Staging
#   docker compose --profile prod   up -d        # Production
#
# Pre-requisites:
#   - Copy .env.example to .env.dev and fill in values
#   - Run: docker compose --env-file .env.dev --profile dev up -d
# =============================================================================

# ---------------------------------------------------------------------------
# Services
# ---------------------------------------------------------------------------
services:

  # =========================================================================
  # 1. Apache NiFi 1.28.1 (Data Flow Engine)
  # =========================================================================
  nifi:
    build:
      context: ./docker/nifi
      dockerfile: Dockerfile
    container_name: oilgas-nifi
    hostname: nifi
    ports:
      - "${NIFI_WEB_PORT:-8443}:8443"
    environment:
      # --- Web server (HTTPS mode - enables Single User Login) ---
      NIFI_WEB_HTTPS_PORT: 8443
      NIFI_WEB_HTTPS_HOST: 0.0.0.0
      NIFI_WEB_PROXY_HOST: "localhost:${NIFI_WEB_PORT:-8443},0.0.0.0:${NIFI_WEB_PORT:-8443}"
      # --- Authentication ---
      SINGLE_USER_CREDENTIALS_USERNAME: ${NIFI_USERNAME:-admin}
      SINGLE_USER_CREDENTIALS_PASSWORD: ${NIFI_PASSWORD:?NIFI_PASSWORD is required (min 12 chars)}
      NIFI_SENSITIVE_PROPS_KEY: ${NIFI_SENSITIVE_KEY:?NIFI_SENSITIVE_KEY is required (min 12 chars)}
      # --- JVM ---
      NIFI_JVM_HEAP_INIT: ${NIFI_HEAP_INIT:-512m}
      NIFI_JVM_HEAP_MAX: ${NIFI_HEAP_MAX:-1g}
      # --- Kafka connectivity ---
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_SASL_USERNAME: ${KAFKA_SASL_USERNAME:-nifi}
      KAFKA_SASL_PASSWORD: ${KAFKA_SASL_PASSWORD:-}
      # --- Schema Registry ---
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
      # --- PostgreSQL reference data ---
      PG_REF_HOST: ${PG_REF_HOST:-postgres}
      PG_REF_PORT: ${PG_REF_PORT:-5432}
      PG_REF_DATABASE: ${PG_REF_DATABASE:-refdata}
      PG_REF_USERNAME: ${PG_REF_USERNAME:-nifi}
      PG_REF_PASSWORD: ${PG_REF_PASSWORD:-}
      # --- TimescaleDB ---
      TSDB_HOST: ${TSDB_HOST:-timescaledb}
      TSDB_PORT: ${TSDB_PORT:-5433}
      TSDB_DATABASE: ${TSDB_DATABASE:-sensordb}
      TSDB_USERNAME: ${TSDB_USERNAME:-nifi}
      TSDB_PASSWORD: ${TSDB_PASSWORD:-}
      # --- MinIO ---
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-nifi-service}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-}
      # --- MQTT ---
      MQTT_BROKER_URI: tcp://mosquitto:1883
      MQTT_USERNAME: ${MQTT_USERNAME:-nifi}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
    volumes:
      - nifi-data:/opt/nifi/nifi-current/flowfile_repository
      - nifi-content:/opt/nifi/nifi-current/content_repository
      - nifi-provenance:/opt/nifi/nifi-current/provenance_repository
      - nifi-state:/opt/nifi/nifi-current/state
      - ./data/import:/data/import
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -ksf https://localhost:8443/nifi-api/access/config > /dev/null"]
      interval: 60s
      timeout: 30s
      start_period: 600s
      retries: 10
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 2. NiFi Registry 1.28.1 (Flow Version Control)
  # =========================================================================
  nifi-registry:
    image: apache/nifi-registry:1.28.1
    container_name: oilgas-nifi-registry
    hostname: nifi-registry
    # Port not exposed to host — access via NiFi internal network only
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 3. Confluent Kafka 7.7.1 (Event Streaming - KRaft mode, SASL/PLAIN)
  # =========================================================================
  kafka:
    image: confluentinc/cp-kafka:7.7.1
    container_name: oilgas-kafka
    hostname: kafka
    # Ports not exposed to host — NiFi and other services connect via internal network
    environment:
      # --- KRaft mode (no Zookeeper) ---
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      # --- Listeners (SASL_PLAINTEXT for external + internal) ---
      KAFKA_LISTENERS: SASL_PLAINTEXT://:9092,SASL_INTERNAL://:29092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: SASL_PLAINTEXT://localhost:9092,SASL_INTERNAL://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_INTERNAL:SASL_PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: SASL_INTERNAL
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      # --- SASL configuration ---
      KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN
      KAFKA_SASL_MECHANISM_CONTROLLER_PROTOCOL: PLAIN
      KAFKA_SUPER_USERS: "User:admin"
      # --- JAAS config via env var (KAFKA_OPTS loads the file) ---
      KAFKA_OPTS: >-
        -Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf
        -DKAFKA_SASL_PASSWORD=${KAFKA_SASL_PASSWORD:?required}
      # --- Broker settings ---
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_LOG_DIRS: /tmp/kraft-combined-logs
      CLUSTER_ID: oilgas-kafka-cluster-001
      # --- Logging ---
      KAFKA_LOG4J_ROOT_LOGLEVEL: WARN
    volumes:
      - ./docker/kafka/kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/localhost/29092'"]
      interval: 15s
      timeout: 10s
      start_period: 60s
      retries: 10
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 4. Kafka Init (Topic Creation - one-shot, SASL auth)
  # =========================================================================
  kafka-init:
    image: confluentinc/cp-kafka:7.7.1
    container_name: oilgas-kafka-init
    entrypoint: ["/bin/bash", "/scripts/create-topics.sh"]
    environment:
      KAFKA_BOOTSTRAP_SERVER: kafka:29092
      # --- SASL auth for admin operations ---
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_client_jaas.conf"
    volumes:
      - ./docker/kafka/create-topics.sh:/scripts/create-topics.sh:ro
      - ./docker/kafka/kafka_server_jaas.conf:/etc/kafka/kafka_client_jaas.conf:ro
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - oilgas-net
    restart: "no"
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 5. Confluent Schema Registry 7.7.1 (SASL auth to Kafka)
  # =========================================================================
  schema-registry:
    image: confluentinc/cp-schema-registry:7.7.1
    container_name: oilgas-schema-registry
    hostname: schema-registry
    # Port not exposed to host — NiFi connects via internal network
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: kafka:29092
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_SCHEMA_COMPATIBILITY_LEVEL: BACKWARD
      SCHEMA_REGISTRY_DEBUG: "false"
      # --- SASL authentication to Kafka ---
      SCHEMA_REGISTRY_KAFKASTORE_SECURITY_PROTOCOL: SASL_PLAINTEXT
      SCHEMA_REGISTRY_KAFKASTORE_SASL_MECHANISM: PLAIN
      SCHEMA_REGISTRY_KAFKASTORE_SASL_JAAS_CONFIG: >-
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="schemaregistry"
        password="sr-kafka-pass";
    depends_on:
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8081/subjects > /dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      start_period: 30s
      retries: 5
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 6. PostgreSQL 16 (Reference Data)
  # =========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: oilgas-postgres
    hostname: postgres
    # Port not exposed to host — NiFi and Grafana connect via internal network
    environment:
      POSTGRES_DB: ${PG_REF_DATABASE:-refdata}
      POSTGRES_USER: ${PG_REF_USERNAME:-nifi}
      POSTGRES_PASSWORD: ${PG_REF_PASSWORD:?PG_REF_PASSWORD is required}
    volumes:
      - ./docker/postgresql/init:/docker-entrypoint-initdb.d:ro
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_REF_USERNAME:-nifi} -d ${PG_REF_DATABASE:-refdata}"]
      interval: 10s
      timeout: 5s
      start_period: 15s
      retries: 5
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 7. TimescaleDB (Time-Series Storage)
  # =========================================================================
  timescaledb:
    image: timescale/timescaledb:2.25.1-pg16
    container_name: oilgas-timescaledb
    hostname: timescaledb
    # Port not exposed to host — NiFi and Grafana connect via internal network
    environment:
      POSTGRES_DB: ${TSDB_DATABASE:-sensordb}
      POSTGRES_USER: ${TSDB_USERNAME:-nifi}
      POSTGRES_PASSWORD: ${TSDB_PASSWORD:?TSDB_PASSWORD is required}
    volumes:
      - ./docker/timescaledb/init:/docker-entrypoint-initdb.d:ro
      - timescaledb-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TSDB_USERNAME:-nifi} -d ${TSDB_DATABASE:-sensordb}"]
      interval: 10s
      timeout: 5s
      start_period: 60s
      retries: 5
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 8. MinIO (S3-Compatible Data Lake)
  # =========================================================================
  minio:
    image: minio/minio:RELEASE.2025-02-18T16-25-55Z
    container_name: oilgas-minio
    hostname: minio
    ports:
      # Only Console exposed to host; API port internal only
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?MINIO_ROOT_PASSWORD is required}
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9000/minio/health/live > /dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      start_period: 15s
      retries: 5
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 9. MinIO Init (Bucket Creation - one-shot)
  # =========================================================================
  minio-init:
    image: minio/mc:latest
    container_name: oilgas-minio-init
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD} &&
      mc mb --ignore-existing local/sensor-data &&
      mc mb --ignore-existing local/sensor-dlq &&
      mc mb --ignore-existing local/sensor-backups &&
      echo '[minio-init] All buckets created successfully.' &&
      mc ls local
      "
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?MINIO_ROOT_PASSWORD is required}
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - oilgas-net
    restart: "no"
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 10. Grafana OSS 11.4.0 (Dashboards & Visualization)
  # =========================================================================
  grafana:
    image: grafana/grafana-oss:11.4.0
    container_name: oilgas-grafana
    hostname: grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD is required}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: "http://localhost:${GRAFANA_PORT:-3000}"
      GF_INSTALL_PLUGINS: ""
      # --- Datasource credentials (env var substitution in provisioning YAML) ---
      GF_DATASOURCE_TSDB_PASSWORD: ${GRAFANA_READER_PASSWORD:-grafana_readonly_pass}
      GF_DATASOURCE_PG_PASSWORD: ${GRAFANA_READER_PASSWORD:-grafana_readonly_pass}
    volumes:
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      timescaledb:
        condition: service_healthy
      prometheus:
        condition: service_started
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 11. Prometheus v2.54.0 (Metrics Collection)
  # =========================================================================
  prometheus:
    image: prom/prometheus:v2.54.0
    container_name: oilgas-prometheus
    hostname: prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/prometheus/alert-rules.yml:/etc/prometheus/alert-rules.yml:ro
      - prometheus-data:/prometheus
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 12. Kafka Exporter (Kafka Metrics for Prometheus)
  # =========================================================================
  kafka-exporter:
    image: danielqsj/kafka-exporter:v1.7.0
    container_name: oilgas-kafka-exporter
    hostname: kafka-exporter
    command:
      - --kafka.server=kafka:29092
      - --sasl.enabled
      - --sasl.mechanism=plain
      - --sasl.username=${KAFKA_SASL_USERNAME:-nifi}
      - --sasl.password=${KAFKA_SASL_PASSWORD:?KAFKA_SASL_PASSWORD is required}
      - --group.filter=.+
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 13. Alertmanager v0.27.0 (Alert Routing)
  # =========================================================================
  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: oilgas-alertmanager
    hostname: alertmanager
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
    volumes:
      - ./docker/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    depends_on:
      prometheus:
        condition: service_started
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]

  # =========================================================================
  # 14. Eclipse Mosquitto 2 (MQTT Broker - Password Auth)
  # =========================================================================
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: oilgas-mosquitto
    hostname: mosquitto
    # Ports not exposed to host — data-generator and NiFi connect via internal network
    environment:
      MQTT_USERNAME: ${MQTT_USERNAME:-nifi}
      MQTT_PASSWORD: ${MQTT_PASSWORD:?MQTT_PASSWORD is required}
    entrypoint: >
      /bin/sh -c "
      rm -f /mosquitto/config/passwd &&
      mosquitto_passwd -c -b /mosquitto/config/passwd $${MQTT_USERNAME} $${MQTT_PASSWORD} &&
      chmod 644 /mosquitto/config/passwd &&
      echo '[mosquitto] Password file created for user: '$${MQTT_USERNAME} &&
      exec mosquitto -c /mosquitto/config/mosquitto.conf
      "
    volumes:
      - ./docker/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
    networks:
      - oilgas-net
    restart: unless-stopped
    profiles: ["dev", "staging", "prod"]


  # ---------------------------------------------------------------------------
  # Data Generator - Simulated Oil & Gas Sensor Data
  # ---------------------------------------------------------------------------
  data-generator:
    build:
      context: ./data-generator
      dockerfile: Dockerfile
    container_name: oilgas-data-generator
    hostname: data-generator
    restart: unless-stopped
    environment:
      MQTT_BROKER: mosquitto
      MQTT_PORT: "1883"
      MQTT_USERNAME: ${MQTT_USERNAME:-nifi}
      MQTT_PASSWORD: ${MQTT_PASSWORD:?MQTT_PASSWORD is required}
      INTERVAL_SECONDS: "10"
      ANOMALY_PROBABILITY: "0.05"
      PLATFORMS: ALPHA,BRAVO,CHARLIE,DELTA,ECHO
      NIFI_HTTPS_URL: "https://nifi:8443"
      LOG_LEVEL: INFO
    depends_on:
      mosquitto:
        condition: service_started
    networks:
      - oilgas-net
    profiles: ["dev", "staging", "prod"]

# ---------------------------------------------------------------------------
# Networks
# ---------------------------------------------------------------------------
networks:
  oilgas-net:
    name: oilgas-net
    driver: bridge

# ---------------------------------------------------------------------------
# Volumes
# ---------------------------------------------------------------------------
volumes:
  nifi-data:
    name: oilgas-nifi-data
  nifi-content:
    name: oilgas-nifi-content
  nifi-provenance:
    name: oilgas-nifi-provenance
  nifi-state:
    name: oilgas-nifi-state
  postgres-data:
    name: oilgas-postgres-data
  timescaledb-data:
    name: oilgas-timescaledb-data
  minio-data:
    name: oilgas-minio-data
  grafana-data:
    name: oilgas-grafana-data
  prometheus-data:
    name: oilgas-prometheus-data
  mosquitto-data:
    name: oilgas-mosquitto-data
  mosquitto-log:
    name: oilgas-mosquitto-log
