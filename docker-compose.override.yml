# =============================================================================
# NiFi Oil & Gas Monitoring Platform - Development Overrides
# =============================================================================
# Automatically loaded by Docker Compose alongside docker-compose.yml.
# Adds debug ports, verbose logging, and developer-friendly settings.
#
# Usage:
#   docker compose --env-file .env.dev --profile dev up -d
#
# To skip overrides (staging/prod):
#   docker compose -f docker-compose.yml --env-file .env.staging --profile staging up -d
# =============================================================================

services:

  # =========================================================================
  # NiFi - Development overrides
  # =========================================================================
  nifi:
    environment:
      # Lower heap for dev machines
      NIFI_HEAP_INIT: ${NIFI_HEAP_INIT:-512m}
      NIFI_HEAP_MAX: ${NIFI_HEAP_MAX:-1g}
      NIFI_LOG_LEVEL: INFO
    ports:
      - "${NIFI_WEB_PORT:-8080}:8080"
    volumes:
      - nifi-data:/opt/nifi/nifi-current/flowfile_repository
      - nifi-content:/opt/nifi/nifi-current/content_repository
      - nifi-provenance:/opt/nifi/nifi-current/provenance_repository
      - nifi-state:/opt/nifi/nifi-current/state
      - ./data/import:/data/import

  # =========================================================================
  # NiFi Registry - Development overrides
  # =========================================================================
  nifi-registry:
    # Persist registry database locally for dev
    volumes:
      - nifi-registry-data:/opt/nifi-registry/nifi-registry-current/database
      - ./nifi-flows:/opt/nifi-registry/nifi-registry-current/flow_storage

  # =========================================================================
  # Kafka - Development overrides
  # =========================================================================
  kafka:
    environment:
      # Enable more verbose logging in dev
      KAFKA_LOG4J_ROOT_LOGLEVEL: INFO
    ports:
      - "${KAFKA_BROKER_PORT:-9092}:9092"
      - "${KAFKA_INTERNAL_PORT:-29092}:29092"
      # JMX metrics for Kafka debugging
      - "9101:9101"

  # =========================================================================
  # Schema Registry - Development overrides
  # =========================================================================
  schema-registry:
    environment:
      SCHEMA_REGISTRY_DEBUG: "true"

  # =========================================================================
  # PostgreSQL - Development overrides
  # =========================================================================
  postgres:
    ports:
      - "${PG_REF_PORT:-5432}:5432"
    # Enable query logging in dev
    command: >
      postgres
        -c log_statement=all
        -c log_duration=on
        -c log_min_duration_statement=100

  # =========================================================================
  # TimescaleDB - Development overrides
  # =========================================================================
  timescaledb:
    ports:
      - "${TSDB_PORT:-5433}:5432"
    command: >
      postgres
        -c log_statement=all
        -c log_duration=on
        -c log_min_duration_statement=100
        -c shared_preload_libraries=timescaledb

  # =========================================================================
  # MinIO - Development overrides
  # =========================================================================
  minio:
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"

  # =========================================================================
  # Grafana - Development overrides
  # =========================================================================
  grafana:
    environment:
      GF_LOG_LEVEL: debug
      GF_USERS_ALLOW_SIGN_UP: "true"
      # Enable anonymous access for dev convenience
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer

  # =========================================================================
  # Prometheus - Development overrides
  # =========================================================================
  prometheus:
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=3d"
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"

  # =========================================================================
  # Mosquitto - Development overrides
  # =========================================================================
  mosquitto:
    ports:
      - "${MQTT_PORT:-1883}:1883"
      - "${MQTT_WS_PORT:-9883}:9883"
