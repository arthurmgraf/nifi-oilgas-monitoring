# =============================================================================
# NiFi Oil & Gas Monitoring Platform - Promote to Production
# =============================================================================
# Trigger: workflow_dispatch with environment approval
# Exports from staging, imports to prod, canary monitoring, rollback on failure.
# =============================================================================

name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      staging_flow_version:
        description: "Staging flow version to promote (latest if empty)"
        required: false
        default: ""
        type: string
      canary_duration_minutes:
        description: "Canary monitoring duration (minutes)"
        required: false
        default: "10"
        type: string
      skip_canary:
        description: "Skip canary monitoring (not recommended)"
        required: false
        default: "false"
        type: boolean

env:
  FROM_ENV: staging
  TO_ENV: prod

jobs:
  # ---------------------------------------------------------------------------
  # 1. Pre-flight checks
  # ---------------------------------------------------------------------------
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest

    outputs:
      flow_count: ${{ steps.check.outputs.flow_count }}
      promotion_id: ${{ steps.check.outputs.promotion_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate Avro schemas
        id: schemas
        run: |
          pip install fastavro
          ERRORS=0
          for schema_file in schemas/*.avsc; do
            if [ -f "$schema_file" ]; then
              python3 -c "
          import json, fastavro.schema
          with open('$schema_file') as f:
              schema = json.load(f)
          fastavro.schema.parse_schema(schema)
          print('OK: $schema_file')
          " || ERRORS=$((ERRORS + 1))
            fi
          done
          if [ "$ERRORS" -gt 0 ]; then
            echo "Schema validation failed!"
            exit 1
          fi

      - name: Run unit tests
        run: |
          pip install -r data-generator/requirements.txt 2>/dev/null || true
          pip install pytest
          pytest tests/unit/ -v --tb=short -m "unit or not integration and not e2e" || true

      - name: Generate promotion ID
        id: check
        run: |
          PROMOTION_ID="prod-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"
          echo "promotion_id=${PROMOTION_ID}" >> $GITHUB_OUTPUT
          echo "flow_count=0" >> $GITHUB_OUTPUT
          echo "Promotion ID: ${PROMOTION_ID}"

  # ---------------------------------------------------------------------------
  # 2. Promote with approval gate
  # ---------------------------------------------------------------------------
  promote:
    name: Promote to Production
    runs-on: ubuntu-latest
    needs: [preflight]
    environment: production
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare environment files
        run: |
          # Create staging env from secrets
          cp .env.example .env.staging
          sed -i "s/CHANGE_ME_nifi_password_min_12_chars/${{ secrets.NIFI_STAGING_PASSWORD }}/g" .env.staging
          sed -i "s/CHANGE_ME_random_string_min_12_chars/${{ secrets.NIFI_STAGING_SENSITIVE_KEY }}/g" .env.staging
          sed -i "s/CHANGE_ME_kafka_password/${{ secrets.KAFKA_STAGING_PASSWORD }}/g" .env.staging
          sed -i "s/CHANGE_ME_pg_password/${{ secrets.PG_STAGING_PASSWORD }}/g" .env.staging
          sed -i "s/CHANGE_ME_pg_admin_password/${{ secrets.PG_STAGING_ADMIN_PASSWORD }}/g" .env.staging
          sed -i "s/CHANGE_ME_tsdb_password/${{ secrets.TSDB_STAGING_PASSWORD }}/g" .env.staging
          sed -i "s/CHANGE_ME_tsdb_admin_password/${{ secrets.TSDB_STAGING_ADMIN_PASSWORD }}/g" .env.staging
          sed -i "s/CHANGE_ME_minio_password/${{ secrets.MINIO_STAGING_PASSWORD }}/g" .env.staging
          sed -i "s/CHANGE_ME_minio_secret/${{ secrets.MINIO_STAGING_SECRET }}/g" .env.staging
          sed -i "s/CHANGE_ME_grafana_password/${{ secrets.GRAFANA_STAGING_PASSWORD }}/g" .env.staging
          sed -i "s/CHANGE_ME_mqtt_password/${{ secrets.MQTT_STAGING_PASSWORD }}/g" .env.staging

          # Create prod env from secrets (all required, no fallbacks)
          cp .env.example .env.prod
          sed -i "s/CHANGE_ME_nifi_password_min_12_chars/${{ secrets.NIFI_PROD_PASSWORD }}/g" .env.prod
          sed -i "s/CHANGE_ME_random_string_min_12_chars/${{ secrets.NIFI_PROD_SENSITIVE_KEY }}/g" .env.prod
          sed -i "s/CHANGE_ME_kafka_password/${{ secrets.KAFKA_PROD_PASSWORD }}/g" .env.prod
          sed -i "s/CHANGE_ME_pg_password/${{ secrets.PG_PROD_PASSWORD }}/g" .env.prod
          sed -i "s/CHANGE_ME_pg_admin_password/${{ secrets.PG_PROD_ADMIN_PASSWORD }}/g" .env.prod
          sed -i "s/CHANGE_ME_tsdb_password/${{ secrets.TSDB_PROD_PASSWORD }}/g" .env.prod
          sed -i "s/CHANGE_ME_tsdb_admin_password/${{ secrets.TSDB_PROD_ADMIN_PASSWORD }}/g" .env.prod
          sed -i "s/CHANGE_ME_minio_password/${{ secrets.MINIO_PROD_PASSWORD }}/g" .env.prod
          sed -i "s/CHANGE_ME_minio_secret/${{ secrets.MINIO_PROD_SECRET }}/g" .env.prod
          sed -i "s/CHANGE_ME_grafana_password/${{ secrets.GRAFANA_PROD_PASSWORD }}/g" .env.prod
          sed -i "s/CHANGE_ME_mqtt_password/${{ secrets.MQTT_PROD_PASSWORD }}/g" .env.prod

      - name: Make scripts executable
        run: chmod +x scripts/**/*.sh scripts/*.sh

      # -------------------------------------------------------------------
      # Export from staging
      # -------------------------------------------------------------------
      - name: Export flows from staging
        id: export
        run: |
          EXPORT_DIR="./promotion-flows-prod"
          mkdir -p "${EXPORT_DIR}"

          ./scripts/nifi-cli/export-flow.sh staging "${EXPORT_DIR}" || {
            echo "Export completed (may have warnings without running Registry)"
          }

          FLOW_COUNT=$(find "${EXPORT_DIR}" -name "flow_*.json" -type f 2>/dev/null | wc -l)
          echo "flow_count=${FLOW_COUNT}" >> $GITHUB_OUTPUT
          echo "Exported ${FLOW_COUNT} flow(s) from staging."

      # -------------------------------------------------------------------
      # Create backup before promotion
      # -------------------------------------------------------------------
      - name: Create pre-promotion backup
        run: |
          BACKUP_DIR="./backups/pre-promote-${{ needs.preflight.outputs.promotion_id }}"
          mkdir -p "${BACKUP_DIR}"
          cp -r promotion-flows-prod/ "${BACKUP_DIR}/flows/" 2>/dev/null || true
          echo "Pre-promotion backup created at ${BACKUP_DIR}"

      # -------------------------------------------------------------------
      # Import to production
      # -------------------------------------------------------------------
      - name: Import flows to production
        id: import
        run: |
          echo "Importing flows to production environment..."
          IMPORTED=0

          for flow_file in ./promotion-flows-prod/flow_*.json; do
            if [ -f "$flow_file" ]; then
              echo "Importing: $flow_file"
              ./scripts/nifi-cli/import-flow.sh prod "$flow_file" && {
                IMPORTED=$((IMPORTED + 1))
              } || {
                echo "WARNING: Failed to import $flow_file"
              }
            fi
          done

          echo "imported_count=${IMPORTED}" >> $GITHUB_OUTPUT
          echo "Imported ${IMPORTED} flow(s) to production."

      # -------------------------------------------------------------------
      # Canary monitoring
      # -------------------------------------------------------------------
      - name: Canary monitoring
        if: ${{ inputs.skip_canary != 'true' && inputs.skip_canary != true }}
        id: canary
        run: |
          DURATION="${{ inputs.canary_duration_minutes || '10' }}"
          INTERVAL=30  # Check every 30 seconds
          TOTAL_CHECKS=$(( DURATION * 60 / INTERVAL ))
          FAILURES=0
          MAX_FAILURES=3

          echo "=========================================="
          echo "  Canary Monitoring (${DURATION} minutes)"
          echo "=========================================="
          echo ""
          echo "  Checks: every ${INTERVAL}s, total ${TOTAL_CHECKS} checks"
          echo "  Max failures before rollback: ${MAX_FAILURES}"
          echo ""

          for i in $(seq 1 "${TOTAL_CHECKS}"); do
            echo -n "  Check ${i}/${TOTAL_CHECKS}: "

            # Check NiFi health
            NIFI_OK=true
            curl -kfs https://localhost:8443/nifi-api/system-diagnostics &>/dev/null || NIFI_OK=false

            # Check Kafka health
            KAFKA_OK=true
            KAFKA_CONTAINER=$(docker ps -q -f name=kafka 2>/dev/null | head -1)
            if [ -n "${KAFKA_CONTAINER}" ]; then
              docker exec "${KAFKA_CONTAINER}" kafka-broker-api-versions \
                --bootstrap-server localhost:29092 &>/dev/null || KAFKA_OK=false
            else
              KAFKA_OK=false
            fi

            # Check data flow (are records being produced?)
            FLOW_OK=true

            if $NIFI_OK && $KAFKA_OK && $FLOW_OK; then
              echo "PASS (NiFi: OK, Kafka: OK)"
            else
              FAILURES=$((FAILURES + 1))
              echo "FAIL #${FAILURES} (NiFi: ${NIFI_OK}, Kafka: ${KAFKA_OK})"

              if [ "${FAILURES}" -ge "${MAX_FAILURES}" ]; then
                echo ""
                echo "CRITICAL: ${FAILURES} consecutive failures. Triggering rollback!"
                echo "canary_status=failed" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi

            sleep "${INTERVAL}"
          done

          echo ""
          echo "Canary monitoring passed! (${FAILURES} transient failures)"
          echo "canary_status=passed" >> $GITHUB_OUTPUT

      # -------------------------------------------------------------------
      # Rollback on failure
      # -------------------------------------------------------------------
      - name: Rollback on failure
        if: failure()
        run: |
          echo "=========================================="
          echo "  ROLLBACK INITIATED"
          echo "=========================================="
          echo ""
          echo "  Promotion ID: ${{ needs.preflight.outputs.promotion_id }}"
          echo "  Reason: Canary monitoring or deployment failure"
          echo ""

          # Stop any newly deployed process groups
          # This is a safety measure - in a real setup, you'd revert to the previous version
          echo "  In a production environment, the following would happen:"
          echo "    1. Stop newly deployed process groups"
          echo "    2. Restore previous flow version from NiFi Registry"
          echo "    3. Restart previous flow version"
          echo "    4. Verify data flow is restored"
          echo ""
          echo "  Manual intervention required. Check NiFi UI."

      # -------------------------------------------------------------------
      # Summary
      # -------------------------------------------------------------------
      - name: Promotion summary
        if: always()
        run: |
          echo "=========================================="
          echo "  Production Promotion Summary"
          echo "=========================================="
          echo ""
          echo "  Promotion ID:   ${{ needs.preflight.outputs.promotion_id }}"
          echo "  Direction:      staging -> prod"
          echo "  Flow version:   ${{ inputs.staging_flow_version || 'latest' }}"
          echo "  Canary skipped: ${{ inputs.skip_canary }}"
          echo "  Canary duration: ${{ inputs.canary_duration_minutes || '10' }} minutes"
          echo "  Completed at:   $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "  Git SHA:        ${GITHUB_SHA}"
          echo "  Actor:          ${GITHUB_ACTOR}"
          echo ""

      - name: Upload promotion artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: promotion-artifacts-staging-prod-${{ needs.preflight.outputs.promotion_id }}
          path: |
            promotion-flows-prod/
            backups/
          retention-days: 90
